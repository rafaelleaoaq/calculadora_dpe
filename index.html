<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora de Execução de Alimentos</title>
  
  <style>
    body {
  font-family: Arial, sans-serif;
  background: #f8f9fa;
  padding: 18px;
}

.container {
  background: #fff;
  padding: 24px 26px 12px;
  border-radius: 18px;
  margin: 30px auto;
  box-shadow: 0 0 14px #b5d8c2;
  border-top: 10px solid #207239;
  border-bottom: 10px solid #207239;
  width: fit-content;
  min-width: 900px;
}

.logo-dpe {
  display: flex;
  justify-content: center;
  margin-bottom: 6px;
}

.logo-dpe img {
  height: 75px;
}

h2 {
  color: #207239;
  text-align: center;
  font-size: 1.5em; 
  margin: 8px 0 18px 0;
  letter-spacing: 0.4px;
  font-weight: bold;
}

hr.divisor {
  margin: 20px 0 16px 0;
  border: 1px solid #e0e0e0;
}

.form-row,
.form-row-destaque {
  display: flex;
  flex-wrap: wrap;
  gap: 15px;
  margin-bottom: 12px;
  align-items: flex-end;
}

.form-row-destaque {
  background: #f7faf8;
  padding: 10px;
  border-radius: 8px;
  border: 1px solid #b5d8c2;
  margin-top: 10px;
}

.form-group {
  flex: 1;
  display: flex;
  flex-direction: column;
  min-width: 180px;
}

.form-group > label {
  font-weight: bold;
  margin-bottom: 4px;
  color: #207239;
  font-size: 0.85em;
}

.form-group input,
.form-group select {
  padding: 8px 6px;
  font-size: 0.92em;
  border: 1.2px solid #b5d8c2;
  border-radius: 5px;
  color: #207239;
  background: #fff;
  width: 100%;
  box-sizing: border-box;
}

.form-group input:read-only {
  background: #e8f3ec;
  color: #175728;
  font-weight: bold;
  cursor: not-allowed;
}

.form-row-btn-center {
  display: flex;
  justify-content: center;
  width: 100%;
}

/* --- ESTILOS PARA PERÍODOS DINÂMICOS (FINAL) --- */
#periodosSection {
    width: 100%;
    margin-top: 15px;
}
#periodosSection .main-periodo-label {
    font-weight: bold;
    margin-bottom: 8px;
    color: #207239;
    font-size: 0.9em;
    display: block;
}
#periodosContainer {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
    gap: 15px;
}
.periodo-row {
    display: flex;
    gap: 10px;
    align-items: flex-end;
    padding: 12px;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    background-color: #fdfdfd;
}
.periodo-row .form-group {
    min-width: 120px;
}
.remove-periodo-btn {
    background: #e8f3ec;
    color: #207239;
    border: 1px solid #b5d8c2;
    border-radius: 50%;
    cursor: pointer;
    width: 30px;
    height: 30px;
    font-size: 1.2em;
    font-weight: bold;
    line-height: 28px;
    padding: 0;
    text-align: center;
    flex-shrink: 0;
    transition: all 0.2s;
}
.remove-periodo-btn:hover {
    background: #cce8d6;
    border-color: #207239;
}
#addPeriodoBtn {
    background: #f0fdf4;
    border: 1.5px dashed #b5d8c2;
    color: #207239;
    padding: 8px 12px;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.9em;
    margin-top: 15px;
    width: 100%;
    text-align: center;
    transition: background-color 0.2s;
}
#addPeriodoBtn:hover {
    background: #e8f3ec;
}

/* Estilos comuns a todos os botões de ação */
#calcularBtn, #pdfBtn, #gerarTabelaVariavelBtn {
    border: none;
    background: #207239;
    color: #fff;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 500;
    transition: background 0.18s;
}

#calcularBtn:hover, #pdfBtn:hover, #gerarTabelaVariavelBtn:hover {
  background: #175728;
}

#calcularBtn {
    margin: 20px 0;
    padding: 12px 30px;
    font-size: 1.05em;
    font-weight: bold;
    min-width: 220px;
}

#pdfBtn {
  margin: 16px 0 8px 0;
  padding: 8px 22px;
  font-size: 0.95em;
}

#gerarTabelaVariavelBtn {
  width: 100%;
  padding: 10px;
  margin-top: 15px; 
  font-size: 0.95em;
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 18px;
}

th, td {
  border: 1px solid #b5d8c2;
  padding: 4px 6px;
  text-align: center;
  vertical-align: middle;
}

th {
  background: #b5d8c2;
  color: #207239;
  font-weight: bold;
  font-size: 0.9em;
}

.powered-by {
  text-align: right;
  font-size: 0.85em;
  color: #619c73;
  margin: 6px 2px 0 2px;
  letter-spacing: 0.03em;
}
.acao-com-instrucoes {
  display: flex;
  align-items: flex-start;
  gap: 20px;
  margin-top: 12px;
  flex-wrap: wrap;
}

.instrucoes-box {
  flex: 1;
  font-size: 0.92em;
  color: #207239; 
  background: #f8f8f8;
  padding: 12px 16px;
  border-radius: 6px;
  border: 1px solid #ccc;
  max-width: 600px;
  min-width: 250px;
}

.instrucoes-box ol, .instrucoes-box li {
  padding-left: 18px;
  margin: 0;
  margin-bottom: 6px;
  font-weight: 500;
}

.instrucoes-box strong {
    color: #175728;
    font-weight: bold;
}

/* --- NOVOS ESTILOS PARA TELA PENSÃO/DIAS --- */
#telaPensaoDias {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 25px;
    margin-top: 20px;
}
.calc-card {
    background: #fdfdfd;
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 20px;
}
.calc-card h3 {
    text-align: center;
    color: #207239;
    margin-top: 0;
    margin-bottom: 20px;
    font-size: 1.1em;
}
.calc-sub-card {
    margin-bottom: 20px;
}
.calc-sub-card:last-child {
    margin-bottom: 0;
}
.result-display {
    background-color: #e8f3ec;
    border-radius: 5px;
    padding: 8px;
    text-align: center;
    font-weight: bold;
    color: #175728;
    margin-top: 10px;
    min-height: 37px;
}
  </style>
</head>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Listener para formatar campos de dinheiro
    document.body.addEventListener('input', function(event) {
        if (event.target.classList.contains('dinheiro')) {
            const input = event.target;
            let valor = input.value.replace(/\D/g, "");
            valor = (parseInt(valor, 10) || 0).toString();
            while (valor.length < 3) valor = "0" + valor;
            let parteInteira = valor.slice(0, valor.length - 2);
            let centavos = valor.slice(-2);
            let valorFormatado = parseInt(parteInteira).toLocaleString("pt-BR") + "," + centavos;
            input.value = valorFormatado;
        }
    });

    // Listener para selecionar o conteúdo ao focar
    document.body.addEventListener('focus', function(event) {
        if (event.target.classList.contains('dinheiro')) {
            event.target.select();
        }
    }, true);
  });
</script>
<body>

<div class="container">
  <div class="logo-dpe">
    <img src="https://i.ibb.co/h3xGWBH/logo-dpe.png" alt="Defensoria Pública do Maranhão">
  </div>
  <h2>Calculadora de Execução de Alimentos</h2>

  <form id="form-execucao" autocomplete="off">
    <div class="form-row">
      <div class="form-group">
        <label for="tipoCalculo">Função:</label>
        <select id="tipoCalculo" name="tipoCalculo" required>
          <option value="prisao">Rito da Prisão</option>
          <option value="penhora">Rito da Penhora</option>
          <option value="pensaoDias">Calculadora Pensão/Dias</option>
        </select>
      </div>
      <div class="form-group" id="baseCalculoGroup">
        <label for="baseCalculo">Base de Cálculo</label>
        <select id="baseCalculo" name="baseCalculo" required>
          <option value="salario">Salário-mínimo</option>
          <option value="rendaFixa">Renda Fixa</option>
          <option value="rendaVariavel">Renda Variável</option>
        </select>
      </div>
    </div>
    
    <div id="telaExecucao">
        <div id="periodosSection">
            <label class="main-periodo-label">Período(s) de Inadimplência</label>
            <div id="periodosContainer"></div>
            <button type="button" id="addPeriodoBtn">+ Adicionar Outro Período</button>
        </div>

        <hr class="divisor" id="divisor-principal">

        <div id="linhaSalario" style="display:none;">
          <div class="form-row">
            <div class="form-group"><label for="salarioMinimoInput">Salário-mínimo atual</label><input type="text" class="dinheiro" id="salarioMinimoInput" readonly value="1.518,00"></div>
            <div class="form-group"><label for="percentualSalario">Percentual</label><input type="number" id="percentualSalario" min="0" step="0.01" max="100" value=""></div>
            <div class="form-group"><label for="valorAlimentosSal">Valor dos Alimentos</label><input type="text" class="dinheiro" id="valorAlimentosSal" readonly></div>
          </div>
        </div>

        <div id="linhaFixaPrisao" style="display:none;">
          <div class="form-row">
            <div class="form-group"><label for="rendimentoBrutoFixoPrisao">Renda Bruta (R$)</label><input type="text" class="dinheiro" id="rendimentoBrutoFixoPrisao"></div>
            <div class="form-group"><label for="descontoInssFixo">Desconto INSS (R$)</label><input type="text" class="dinheiro" id="descontoInssFixo" readonly></div>
            <div class="form-group"><label for="descontoIrrfFixo">Desconto IRRF (R$)</label><input type="text" class="dinheiro" id="descontoIrrfFixo" readonly></div>
            <div class="form-group"><label for="rendimentoLiquidoFixoPrisao">Renda Líquida (R$)</label><input type="text" class="dinheiro" id="rendimentoLiquidoFixoPrisao" readonly></div>
          </div>
          <div class="form-row-destaque">
             <div class="form-group"><label for="percentualRendimentoPrisao">Percentual dos Alimentos (%)</label><input type="number" id="percentualRendimentoPrisao" min="0" step="0.01" max="100"></div>
             <div class="form-group"><label for="valorAlimentosRendPrisao">Valor Final dos Alimentos (R$)</label><input type="text" class="dinheiro" id="valorAlimentosRendPrisao" readonly></div>
          </div>
        </div>

        <div id="linhaVariavelPrisao" style="display:none;">
           <div class="acao-com-instrucoes">
               <div class="form-group" style="max-width: 170px; flex-shrink: 0;">
                  <label for="percentualRendimentoVariavel">Percentual da Renda (%)</label>
                  <input type="number" id="percentualRendimentoVariavel" min="0" step="0.01" max="100">
                  <button type="button" id="gerarTabelaVariavelBtn">Gerar Tabela de Lançamentos</button>
                </div>
                <div class="instrucoes-box">
                  <strong>Instruções:</strong>
                  <ol>
                    <li>Informe a <strong>data de início</strong> e a <strong>data do fim</strong> do período de inadimplência.</li>
                    <li>Preencha o <strong>percentual da renda</strong> que deve ser aplicado (ex: 30 para 30%).</li>
                    <li>Clique em <strong>"Gerar tabela"</strong>.</li>
                    <li>Na tabela gerada, <strong>preencha o rendimento bruto</strong> de cada mês.</li>
                    <li>Se houve <strong>pagamento parcial</strong>, informe o valor pago no respectivo mês. A diferença será calculada automaticamente.</li>
                  </ol>
                </div>
           </div>
        </div>
        
        <div class="form-row-btn-center" id="actionButtons">
          <button type="button" id="calcularBtn">Calcular</button>
        </div>
    </div>
    
    <div id="telaPensaoDias" style="display:none;">
        <div class="calc-card">
            <h3>Calculadora de Pensão Alimentícia</h3>
            <div class="calc-sub-card">
                <div class="form-group">
                    <label for="pensaoPercentualInput">Se a pensão é <strong>(%)</strong> do Salário-Mínimo:</label>
                    <input type="number" id="pensaoPercentualInput" min="0" step="0.01" placeholder="Ex: 30">
                </div>
                <div class="result-display" id="pensaoValorResult"></div>
            </div>
            <hr class="divisor">
            <div class="calc-sub-card">
                <div class="form-group">
                    <label for="pensaoValorInput">Se a pensão é de <strong>R$</strong>:</label>
                    <input type="text" class="dinheiro" id="pensaoValorInput" placeholder="Ex: 455,40">
                </div>
                <div class="result-display" id="pensaoPercentualResult"></div>
            </div>
        </div>
        <div class="calc-card">
            <h3>Calculadora de Dias</h3>
            <div class="calc-sub-card">
                <label>Calcular <strong>Dias Corridos</strong> entre:</label>
                <div class="form-row">
                    <div class="form-group"><label for="diasCorridosInicio">Data Inicial</label><input type="date" id="diasCorridosInicio"></div>
                    <div class="form-group"><label for="diasCorridosFim">Data Final</label><input type="date" id="diasCorridosFim"></div>
                </div>
                <div class="result-display" id="diasCorridosResult"></div>
            </div>
            <hr class="divisor">
            <div class="calc-sub-card">
                <label>Calcular <strong>Dias Úteis</strong> entre:</label>
                <div class="form-row">
                    <div class="form-group"><label for="diasUteisInicio">Data Inicial</label><input type="date" id="diasUteisInicio"></div>
                    <div class="form-group"><label for="diasUteisFim">Data Final</label><input type="date" id="diasUteisFim"></div>
                </div>
                <div class="result-display" id="diasUteisResult"></div>
            </div>
        </div>
    </div>
    
    <div id="areaParcelas"></div>
    <div class="form-row-btn-center"><button type="button" id="pdfBtn" style="display:none;">Gerar PDF do Cálculo</button></div>
  </form>

  <div class="powered-by" style="margin-top: 2rem;">Powered by Rafael Leão Alencar Queiroz &nbsp;&nbsp;|&nbsp;&nbsp; Assessor Jurídico DPE - Núcleo São Mateus/MA</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
<script>
(function() {
    'use strict';
    
    const config = {
        salarioMinimo: 1518.00,
        jurosMensal: 0.01,
        multaPenhora: 0.10,
        logoBase64: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAbFBMVEX///8AmmEAlF0Am2IAmV4AnGMAlWEAl2IAkmAAkWAAkFwAk2D4/vjX+d49pWvR9tpyuYFTsXzS9t/h+unL9Nb7/vxtuH7A8c1wun2EyoZnunoAnWbJ89Cfy62Qza5is4G37sZFo2hGqGvO9N62AAAACXBIWXMAAAsTAAALEwEAmpwYAAAFSElEQVR4nO2d63aqPBSGgwgCqgDBfaqoVXvU+z/cJT1lAQLcEw65M+f9rDWN/SSTkGzJJAAAAAAAAAAAAAAAAAAAAAAAgFwE/hBAIQGEChAqwLgLhJ/z8R8/39fP+/3d108d/339qN/A8wA+1U8LgL4VfJ8h/fFv3y8f//wZfL2b+GkK3/+2fn392+VvV9/uV/0v8r+9v3/7/OPvlf9L/K9+fV+e/+/fD/D74Xf6/V+d/f6bAIAqAhAqwLgLhJ/A88KFXw4/z/v3lV8GvwV+X/g9/P3hB/A48I6+v//0V/f3S5+Xv1998s/pC//+5XvFhU/k8wI/2f3y/b/wWb/48t/jCw/eP/v+H3hM//vyz+9/sL+e9xV+f3x79/eL/0eL/yO5H34vH3f7e/yv9V//S8+n/76/xR8gVAAQBECpAoAKkCoAKACgAoAKACgAoAKICgAoQKgCoA6ECgAoAKICgAoQKgCoAKECgAoAKICgAoAKECgAoQKgCoAqACgAoAKICgAoQKgCoAqACgCoAqECgAoAKICgAoQKgCoAKACgCoAqACgAoQKAChAqACgAoAKICgAoQKgCoAqACgAoAKACgAoAKECgAoQKgCoAqACgAoAKICgAoAKACgAoQKAChAqACgAoAKICgAoAKECgCoAqACgAoQKgCoAqECgAoAKICgAoQKgCoAKACgCoAqACgCoAqECgAoAKICgAoQKgCoAKECgAoAKICgAoQKgCoAKECgAoAKACgAoAKECgAoQKgCoAqACgAoAKICgAoAKACgAoAKECgAoAKICgCoAqACgAoQKAChAqACgAoAKICgAoAKECgCoAqACgAoQKgCoAqECgAoAKICgAoQKgCoAKACgAoAKECgAoQKgCoAKECgAoAKACgAoAKACgAoQKAChAqACgAoAKICgAoAKECgCoAqACgAoQKgCoAqECgAoAKICgAoQKgCoAKACgAoAKECgAoQKgCoAKECgAoAKACgAoAKECgAoQKgCoAKECgAoAKICgCoAqACgAoQKAChAqACgAoAKICgAoAKECgCoAqACgAoAKACgAoAKECgAoQKgCoAKECgAoAKICgCoAqACgAoAKACgAoQKAChAqACgAoAKICgAoAKECgCoAqACgAoQKgCoAqECgAoAKICgAoQKgCoAKACgAoAKECgAoQKgCoAKECgAoAKACgAoAKACgAoAKACgAoQKAChAqACgAoAKICgAoAKECgCoAqACgAoQKgCoAqECgAoAKICgAoQKgCoAKACgAoAKECgAoAKICgAoAKACgAoAKACgAoAKECgAoQKgCoAKECgAoAKICgCoAqECgAoAKICgAoAKECgAoAKECgAoAKICgAoAKECgAoAKICgAoAKECgAoAKACgAoAKACgAoAKICgAoAKECgAoAKICgAoAKECgAoAKECgAoAKICgAoAKECgAoAKECgAoAKICgAoAKACgAoAKECgAoAKECgAoAKECgAoAKECgAoAKECgAoAKICgCoAqACgAoAKICgAoAKECgAoAKICgAoAKICgAoAKECgAoAKICgAoAKECgAoQKgCoAqECgAoAKICgAoAKECgAoAKECgAoQKgCoAqECgAoAKICgAoQKgCoAqACgAoAKECgAoAKECgAoAKECgAoAKECgAoAKECgAoAKICgAoQKgCoAKECgAAAAAAAAAAAAAAAAAAAAAAAD/gP0H6J4Sg/Y/v/kAAAAASUVORK5CYII='
    };
    
    const inpcData = {
        "2023": [0.46, 0.77, 0.64, 0.53, 0.36, -0.10, -0.09, 0.20, 0.14, 0.30, 0.10, 0.55],
        "2024": [0.57, 0.84, 0.19, 0.21, 0.45, 0.10, 0.10, 0.12, 0.15, 0.20, 0.22, 0.25], 
        "2025": [0.35, 0.40, 0.38, 0.42, 0.41, 0.39, 0.35, 0.33, 0.31, 0.29, 0.28, 0.30]
    };

    const dom = {
        tipoCalculo: document.getElementById('tipoCalculo'),
        baseCalculoGroup: document.getElementById('baseCalculoGroup'),
        baseCalculo: document.getElementById('baseCalculo'),
        telaExecucao: document.getElementById('telaExecucao'),
        telaPensaoDias: document.getElementById('telaPensaoDias'),
        calcularBtn: document.getElementById('calcularBtn'),
        pdfBtn: document.getElementById('pdfBtn'),
        areaParcelas: document.getElementById('areaParcelas'),
        periodosContainer: document.getElementById('periodosContainer'),
        addPeriodoBtn: document.getElementById('addPeriodoBtn'),
        linhaSalario: document.getElementById('linhaSalario'),
        percentualSalario: document.getElementById('percentualSalario'),
        valorAlimentosSal: document.getElementById('valorAlimentosSal'),
        rendimentoBrutoFixoPrisao: document.getElementById('rendimentoBrutoFixoPrisao'),
        descontoInssFixo: document.getElementById('descontoInssFixo'),
        descontoIrrfFixo: document.getElementById('descontoIrrfFixo'),
        rendimentoLiquidoFixoPrisao: document.getElementById('rendimentoLiquidoFixoPrisao'),
        percentualRendimentoPrisao: document.getElementById('percentualRendimentoPrisao'),
        valorAlimentosRendPrisao: document.getElementById('valorAlimentosRendPrisao'),
        linhaFixaPrisao: document.getElementById('linhaFixaPrisao'),
        linhaVariavelPrisao: document.getElementById('linhaVariavelPrisao'),
        percentualRendimentoVariavel: document.getElementById('percentualRendimentoVariavel'),
        gerarTabelaVariavelBtn: document.getElementById('gerarTabelaVariavelBtn'),
        divisorPrincipal: document.getElementById('divisor-principal'),
        actionButtons: document.getElementById('actionButtons'),
        pensaoPercentualInput: document.getElementById('pensaoPercentualInput'),
        pensaoValorResult: document.getElementById('pensaoValorResult'),
        pensaoValorInput: document.getElementById('pensaoValorInput'),
        pensaoPercentualResult: document.getElementById('pensaoPercentualResult'),
        diasCorridosInicio: document.getElementById('diasCorridosInicio'),
        diasCorridosFim: document.getElementById('diasCorridosFim'),
        diasCorridosResult: document.getElementById('diasCorridosResult'),
        diasUteisInicio: document.getElementById('diasUteisInicio'),
        diasUteisFim: document.getElementById('diasUteisFim'),
        diasUteisResult: document.getElementById('diasUteisResult'),
    };

    const calculator = {
        parseInputDate(str) {
            if (!str) return null;
            const [ano, mes, dia] = str.split('-');
            return new Date(Date.UTC(parseInt(ano), parseInt(mes) - 1, parseInt(dia)));
        },
        getDescontos(rendaBruta) {
            const inssTable = [ { limit: 1412.00, rate: 0.075, deduction: 0 }, { limit: 2666.68, rate: 0.09, deduction: 21.18 }, { limit: 4000.03, rate: 0.12, deduction: 101.18 }, { limit: 7786.02, rate: 0.14, deduction: 181.18 } ];
            const inssTeto = 908.85; let inss = 0;
            if (rendaBruta > inssTable[3].limit) { inss = inssTeto; } else { for (const range of inssTable) { if (rendaBruta <= range.limit) { inss = (rendaBruta * range.rate) - range.deduction; break; } } }
            inss = parseFloat(inss.toFixed(2));
            const baseIrrf = rendaBruta - inss;
            const irrfTable = [ { limit: 2259.20, rate: 0, deduction: 0 }, { limit: 2826.65, rate: 0.075, deduction: 169.44 }, { limit: 3751.05, rate: 0.15, deduction: 381.44 }, { limit: 4664.68, rate: 0.225, deduction: 662.77 }, { limit: Infinity, rate: 0.275, deduction: 896.00 } ];
            let irrf = 0; for (const range of irrfTable) { if (baseIrrf <= range.limit) { irrf = (baseIrrf * range.rate) - range.deduction; break; } }
            irrf = Math.max(0, parseFloat(irrf.toFixed(2)));
            return { liquido: rendaBruta - inss - irrf, inss, irrf };
        },
        getCorrecao(valorBase, dataVenc) {
            const hoje = new Date();
            let fatorAcumulado = 1.0;
            let dataCursor = new Date(dataVenc.getTime());
            dataCursor.setUTCMonth(dataCursor.getUTCMonth() + 1, 1);
            while(dataCursor <= hoje) {
                const ano = String(dataCursor.getUTCFullYear());
                const mes = dataCursor.getUTCMonth();
                if(inpcData[ano] && inpcData[ano][mes] !== undefined) {
                    fatorAcumulado *= (1 + inpcData[ano][mes] / 100);
                }
                dataCursor.setUTCMonth(dataCursor.getUTCMonth() + 1);
            }
            return { correcao: valorBase * (fatorAcumulado - 1) };
        },
        getJuros(valorBase, dataVenc) {
            const hoje = new Date();
            const mesesAtraso = (hoje.getUTCFullYear() - dataVenc.getUTCFullYear()) * 12 + (hoje.getUTCMonth() - dataVenc.getUTCMonth());
            return valorBase * config.jurosMensal * (mesesAtraso > 0 ? mesesAtraso : 0);
        }
    };
    
    const app = {
        state: [],
        focus: { id: null, position: 0 },
        
        formatReais: (valor) => !isNaN(valor) ? valor.toFixed(2).replace('.', ',').replace(/\B(?=(\d{3})+(?!\d))/g, ".") : '0,00',
        parseReais: (str) => !str ? 0 : parseFloat(String(str).replace(/\./g, '').replace(',', '.')),
        
        saveFocus() {
            const el = document.activeElement;
            if (el && el.id) { this.focus = { id: el.id, position: el.selectionStart }; }
        },
        restoreFocus() {
            if (!this.focus.id) return;
            const el = document.getElementById(this.focus.id);
            if (el) { el.focus(); try { el.setSelectionRange(this.focus.position, this.focus.position); } catch (e) {} }
        },
        
        init() {
            dom.tipoCalculo.addEventListener('change', this.toggleFields.bind(this));
            dom.baseCalculo.addEventListener('change', this.toggleFields.bind(this));
            dom.percentualSalario.addEventListener('input', this.updateAlimentosSalario.bind(this));
            const boundUpdateFixo = this.updateRendimentoFixo.bind(this);
            dom.rendimentoBrutoFixoPrisao.addEventListener('input', boundUpdateFixo);
            dom.percentualRendimentoPrisao.addEventListener('input', boundUpdateFixo);
            dom.percentualRendimentoVariavel.addEventListener('input', this.handleTableInput.bind(this));
            dom.calcularBtn.addEventListener('click', this.handleFixoCalc.bind(this));
            dom.gerarTabelaVariavelBtn.addEventListener('click', this.handleVariavelSetup.bind(this));
            dom.pdfBtn.addEventListener('click', this.handlePdf.bind(this));
            dom.areaParcelas.addEventListener('input', this.handleTableInput.bind(this));
            dom.addPeriodoBtn.addEventListener('click', () => this.addPeriodoRow(false));
            this.addPeriodoRow(true);
            dom.pensaoPercentualInput.addEventListener('input', this.updatePensaoPercentToValue.bind(this));
            dom.pensaoValorInput.addEventListener('input', this.updatePensaoValueToPercent.bind(this));
            const diasCorridosHandler = this.updateDiasCorridos.bind(this);
            dom.diasCorridosInicio.addEventListener('change', diasCorridosHandler);
            dom.diasCorridosFim.addEventListener('change', diasCorridosHandler);
            const diasUteisHandler = this.updateDiasUteis.bind(this);
            dom.diasUteisInicio.addEventListener('change', diasUteisHandler);
            dom.diasUteisFim.addEventListener('change', diasUteisHandler);
            this.toggleFields();
        },

        updatePensaoPercentToValue() {
            const percent = parseFloat(dom.pensaoPercentualInput.value) || 0;
            if (percent > 0) {
                const valor = (percent / 100) * config.salarioMinimo;
                dom.pensaoValorResult.textContent = `Equivale a R$ ${this.formatReais(valor)}`;
            } else {
                dom.pensaoValorResult.textContent = '';
            }
        },
        updatePensaoValueToPercent() {
            const rawDigits = dom.pensaoValorInput.value.replace(/\D/g, '');
            const valor = parseFloat(rawDigits) / 100 || 0;
            if (valor > 0 && config.salarioMinimo > 0) {
                const percent = (valor / config.salarioMinimo) * 100;
                dom.pensaoPercentualResult.textContent = `Equivale a ${percent.toFixed(2).replace('.', ',')}% do S.M.`;
            } else {
                dom.pensaoPercentualResult.textContent = '';
            }
        },
        updateDiasCorridos() {
            const inicio = calculator.parseInputDate(dom.diasCorridosInicio.value);
            const fim = calculator.parseInputDate(dom.diasCorridosFim.value);
            if (inicio && fim && fim >= inicio) {
                const diffTime = Math.abs(fim - inicio);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                dom.diasCorridosResult.textContent = `${diffDays} dia(s)`;
            } else {
                dom.diasCorridosResult.textContent = '';
            }
        },
        updateDiasUteis() {
            const inicio = calculator.parseInputDate(dom.diasUteisInicio.value);
            const fim = calculator.parseInputDate(dom.diasUteisFim.value);
            if (inicio && fim && fim >= inicio) {
                let count = 0;
                let current = new Date(inicio.getTime());
                while (current <= fim) {
                    const day = current.getUTCDay();
                    if (day !== 0 && day !== 6) { 
                        count++;
                    }
                    current.setUTCDate(current.getUTCDate() + 1);
                }
                dom.diasUteisResult.textContent = `${count} dia(s) útil(eis)`;
            } else {
                dom.diasUteisResult.textContent = '';
            }
        },

        addPeriodoRow(isInitial = false) {
            const row = document.createElement('div');
            row.className = 'periodo-row';
            const removeButtonHTML = isInitial ? '' : '<button type="button" class="remove-periodo-btn" title="Remover Período">&times;</button>';
            row.innerHTML = `
                <div class="form-group"><label>Início</label><input type="date" class="data-inicio"></div>
                <div class="form-group"><label>Fim</label><input type="date" class="data-fim"></div>
                ${removeButtonHTML}`;
            dom.periodosContainer.appendChild(row);
            if (!isInitial) {
                row.querySelector('.remove-periodo-btn').addEventListener('click', (e) => e.target.closest('.periodo-row').remove());
            }
        },
        getMonthsFromPeriods() {
            const periodRows = dom.periodosContainer.querySelectorAll('.periodo-row');
            const newMonths = [];
            const addedMonths = new Set();
            const base = dom.baseCalculo.value;
            periodRows.forEach(row => {
                const dataIni = calculator.parseInputDate(row.querySelector('.data-inicio').value);
                const dataFim = calculator.parseInputDate(row.querySelector('.data-fim').value);
                if (dataIni && dataFim && dataFim >= dataIni) {
                    let dataVenc = new Date(dataIni.getTime());
                    while(dataVenc <= dataFim) {
                        const ref = `${("0" + (dataVenc.getUTCMonth() + 1)).slice(-2)}/${dataVenc.getUTCFullYear()}`;
                        if (!addedMonths.has(ref)) {
                            addedMonths.add(ref);
                            newMonths.push({ ref, dataVenc: new Date(dataVenc.getTime()), isSalario: (base === 'salario'), isVariavel: (base === 'rendaVariavel'), valorPago: 0, rendaBruta: 0 });
                        }
                        dataVenc.setUTCMonth(dataVenc.getUTCMonth() + 1);
                    }
                }
            });
            newMonths.sort((a, b) => a.dataVenc - b.dataVenc);
            return newMonths;
        },
        clearResults() {
            this.state = [];
            dom.areaParcelas.innerHTML = '';
            dom.pdfBtn.style.display = 'none';
        },
        toggleFields() {
            this.clearResults();
            const funcao = dom.tipoCalculo.value;
            const isExecucao = (funcao === 'prisao' || funcao === 'penhora');
            
            dom.telaExecucao.style.display = isExecucao ? 'block' : 'none';
            dom.telaPensaoDias.style.display = isExecucao ? 'none' : 'grid';
            dom.baseCalculoGroup.style.display = isExecucao ? 'flex' : 'none';

            if (isExecucao) {
                const base = dom.baseCalculo.value;
                const show = (el, condition) => { if(el) el.style.display = condition ? 'block' : 'none'; };
                show(dom.linhaSalario, base === 'salario');
                show(dom.linhaFixaPrisao, base === 'rendaFixa');
                show(dom.linhaVariavelPrisao, base === 'rendaVariavel');
                const showButtons = base === 'salario' || base === 'rendaFixa';
                dom.actionButtons.style.display = showButtons ? 'flex' : 'none';
            }
        },
        updateAlimentosSalario() {
            const perc = this.parseReais(dom.percentualSalario.value) / 100;
            dom.valorAlimentosSal.value = this.formatReais(config.salarioMinimo * perc);
        },
        updateRendimentoFixo() {
            const rendaBruta = this.parseReais(dom.rendimentoBrutoFixoPrisao.value);
            const { liquido, inss, irrf } = calculator.getDescontos(rendaBruta);
            const percentual = this.parseReais(dom.percentualRendimentoPrisao.value) / 100;
            dom.descontoInssFixo.value = this.formatReais(inss);
            dom.descontoIrrfFixo.value = this.formatReais(irrf);
            dom.rendimentoLiquidoFixoPrisao.value = this.formatReais(liquido);
            dom.valorAlimentosRendPrisao.value = this.formatReais(liquido * percentual);
        },
        updateState(index) {
            const p = this.state[index];
            if (!p) return;
            const base = dom.baseCalculo.value;
            const inputBruta = document.getElementById(`bruta-${index}`);
            const inputPago = document.getElementById(`pago-${index}`);
            if (p.isVariavel && inputBruta) p.rendaBruta = this.parseReais(inputBruta.value);
            if (inputPago) p.valorPago = this.parseReais(inputPago.value);
            if (!p.isVariavel) {
                p.rendaBruta = (base === 'salario') ? config.salarioMinimo : this.parseReais(dom.rendimentoBrutoFixoPrisao.value);
            }
            const { liquido, inss, irrf } = calculator.getDescontos(p.rendaBruta);
            p.inss = p.isSalario ? 0 : inss;
            p.irrf = p.isSalario ? 0 : irrf;
            p.rendaLiquida = p.isSalario ? p.rendaBruta : liquido;
            let percentual = 0;
            if(p.isVariavel) percentual = this.parseReais(dom.percentualRendimentoVariavel.value) / 100;
            else if(p.isSalario) percentual = this.parseReais(dom.percentualSalario.value) / 100;
            else percentual = this.parseReais(dom.percentualRendimentoPrisao.value) / 100;
            p.valorDevido = p.isSalario ? p.rendaBruta * percentual : p.rendaLiquida * percentual;
            const saldoDevedor = p.valorDevido - p.valorPago;
            p.correcao = calculator.getCorrecao(saldoDevedor, p.dataVenc).correcao;
            const valorCorrigido = saldoDevedor + p.correcao;
            p.juros = calculator.getJuros(valorCorrigido, p.dataVenc);
            p.valorFinal = valorCorrigido + p.juros;
        },
        renderTable() {
            this.saveFocus();
            dom.areaParcelas.innerHTML = '';
            if (this.state.length === 0) { dom.pdfBtn.style.display = 'none'; return; }
            const isSalario = !!this.state[0].isSalario;
            const headers = isSalario
                ? ['Mês Ref.', 'Valor Devido (R$)', 'Valor Pago (R$)', 'Correção INPC (R$)', 'Juros (R$)', 'Valor Final']
                : ['Mês Ref.', 'Renda Bruta (R$)', 'INSS (R$)', 'IRRF (R$)', 'Renda Líquida (R$)', 'Valor Devido (R$)', 'Valor Pago (R$)', 'Correção INPC (R$)', 'Juros (R$)', 'Valor Final'];
            let subtotal = 0;
            let html = `<table><thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>`;
            this.state.forEach((p, index) => {
                subtotal += p.valorFinal;
                html += `<tr data-index="${index}">`;
                if (isSalario) {
                    html += `<td>${p.ref}</td><td>R$ ${this.formatReais(p.valorDevido)}</td>
                             <td><input type="text" class="dinheiro" id="pago-${index}" value="${this.formatReais(p.valorPago)}"></td>
                             <td>R$ ${this.formatReais(p.correcao)}</td><td>R$ ${this.formatReais(p.juros)}</td>
                             <td>R$ ${this.formatReais(p.valorFinal)}</td>`;
                } else {
                    html += `<td>${p.ref}</td>
                             <td>${p.isVariavel ? `<input type="text" class="dinheiro" id="bruta-${index}" value="${this.formatReais(p.rendaBruta)}">` : `R$ ${this.formatReais(p.rendaBruta)}`}</td>
                             <td style="color:#c00;">R$ -${this.formatReais(p.inss)}</td><td style="color:#c00;">R$ -${this.formatReais(p.irrf)}</td>
                             <td>R$ ${this.formatReais(p.rendaLiquida)}</td><td>R$ ${this.formatReais(p.valorDevido)}</td>
                             <td><input type="text" class="dinheiro" id="pago-${index}" value="${this.formatReais(p.valorPago)}"></td>
                             <td>R$ ${this.formatReais(p.correcao)}</td><td>R$ ${this.formatReais(p.juros)}</td>
                             <td>R$ ${this.formatReais(p.valorFinal)}</td>`;
                }
                html += `</tr>`;
            });
            html += `</tbody><tfoot>`;
            const rito = dom.tipoCalculo.value;
            const multa = (rito === 'penhora') ? subtotal * config.multaPenhora : 0;
            const totalFinal = subtotal + multa;
            const colspan = headers.length - 1;
            if (rito === 'penhora') {
                html += `<tr><td colspan="${colspan}" align="right"><b>SUBTOTAL:</b></td><td><b>R$ ${this.formatReais(totalFinal)}</b></td></tr>`;
                html += `<tr><td colspan="${colspan}" align="right" style="color:#c00;"><b>MULTA DE 10%:</b></td><td style="color:#c00;"><b>R$ ${this.formatReais(multa)}</b></td></tr>`;
            }
            html += `<tr><td colspan="${colspan}" align="right"><b>TOTAL EXECUTÁVEL:</b></td><td><b>R$ ${this.formatReais(totalFinal)}</b></td></tr></tfoot></table>`;
            dom.areaParcelas.innerHTML = html;
            dom.pdfBtn.style.display = 'block';
            this.restoreFocus();
        },
        handleFixoCalc() {
            const base = dom.baseCalculo.value;
            if ((base === 'rendaFixa' && this.parseReais(dom.rendimentoBrutoFixoPrisao.value) <= 0) || (base === 'salario' && this.parseReais(dom.percentualSalario.value) <= 0) || (base === 'rendaFixa' && this.parseReais(dom.percentualRendimentoPrisao.value) <= 0)) { 
                alert("A base de cálculo e o percentual devem ser maiores que zero."); return; 
            }
            const newMonths = this.getMonthsFromPeriods();
            if (newMonths.length === 0) {
                alert("Preencha ao menos um período de inadimplência válido."); return;
            }
            this.state = newMonths;
            this.state.forEach((p, index) => this.updateState(index));
            this.renderTable();
        },
        handleVariavelSetup() {
            const newMonths = this.getMonthsFromPeriods();
            if (newMonths.length === 0) {
                alert("Preencha ao menos um período de inadimplência válido."); return;
            }
            this.state = newMonths;
            this.state.forEach((p, index) => this.updateState(index));
            this.renderTable();
        },
        handleTableInput(event) {
            this.saveFocus();
            if (event.target.id === 'percentualRendimentoVariavel') {
                this.state.forEach((p, index) => this.updateState(index));
            } else {
                const row = event.target.closest('tr');
                if (row) this.updateState(row.dataset.index);
            }
            this.renderTable();
        },
        handlePdf() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('l', 'pt', 'a4');
            const tableEl = dom.areaParcelas.querySelector('table');
            if (!tableEl) { alert("Nenhuma tabela encontrada."); return; }
            
            const primaryColor = '#207239';
            const lightColor = '#e8f3ec'; // Cor para zebrado
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 40;

            const head = [];
            tableEl.querySelectorAll('thead th').forEach(th => head.push(th.textContent));
            const body = [];
            tableEl.querySelectorAll('tbody tr').forEach(row => {
                const rowData = [];
                row.querySelectorAll('td').forEach(cell => {
                    const input = cell.querySelector('input');
                    rowData.push(input ? (input.value || '0,00') : cell.textContent.replace('R$ ', '').trim());
                });
                body.push(rowData);
            });
            
            doc.autoTable({
                head: [head],
                body: body,
                startY: 120,
                theme: 'grid',
                styles: { font: 'helvetica', fontSize: 8, cellPadding: 4, halign: 'center' },
                headStyles: { fillColor: primaryColor, textColor: 255, fontStyle: 'bold', fontSize: 9 },
                alternateRowStyles: { fillColor: lightColor },
                didDrawPage: function(data) {
                    try {
                      doc.addImage(config.logoBase64, 'PNG', margin, 20, 60, 48);
                    } catch (e) { console.error("Erro ao adicionar imagem do logo:", e); }
                    doc.setFontSize(20);
                    doc.setTextColor(primaryColor);
                    doc.setFont('helvetica', 'bold');
                    doc.text("Relatório de Execução de Alimentos", pageWidth / 2, 50, { align: 'center' });
                    doc.setFontSize(10);
                    doc.setFont('helvetica', 'normal');
                    doc.setTextColor(100);
                    doc.text(`Cálculo gerado em: ${new Date().toLocaleDateString('pt-BR')}`, pageWidth / 2, 65, { align: 'center' });
                    doc.setFontSize(8);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(`Página ${data.pageNumber} de ${pageCount}`, margin, doc.internal.pageSize.height - 20);
                    doc.text("Powered by DPE-MA", pageWidth - margin, doc.internal.pageSize.height - 20, { align: 'right' });
                },
            });

            let finalY = doc.autoTable.previous.finalY;
            const totalsX = pageWidth - margin;
            const footerRows = tableEl.querySelectorAll('tfoot tr');

            if (footerRows.length > 0) {
              finalY += 15; 
              doc.setDrawColor(primaryColor);
              doc.line(margin, finalY, totalsX, finalY);
              finalY += 15;
            }
            
            footerRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const label = cells[0].textContent.trim();
                const value = cells[1].textContent.trim();
                doc.setFontSize(10);
                doc.setFont('helvetica', 'bold');
                doc.setTextColor(primaryColor);
                doc.text(label, totalsX - 120, finalY, { align: 'right' });
                doc.setFont('helvetica', 'normal');
                doc.setTextColor(50);
                doc.text(value, totalsX, finalY, { align: 'right' });
                finalY += 15;
            });

            doc.save(`Calculo_Alimentos_${new Date().toLocaleDateString('pt-BR').replace(/\//g, '-')}.pdf`);
        }
    };

    app.init();
})();
</script>
</body>
</html>